<div class="wrapper">
  <div class="controls divider fake-scroll-y">
    <button mat-button mat-icon-button class="back" (click)="previous.emit()">
      <mat-icon>arrow_back</mat-icon>
    </button>
    <mat-form-field floatLabel="never" class="search" [class.show]="showSearch">
      <input matInput #searchInput title="Search" [(ngModel)]="search" spellcheck="false">
      <mat-placeholder>
        <mat-icon>search</mat-icon>
        Search a track
      </mat-placeholder>
      <button mat-button *ngIf="search" matSuffix mat-icon-button aria-label="Clear" (click)="search=''">
        <mat-icon>close</mat-icon>
      </button>
    </mat-form-field>
    <div class="controls-meta" [class.show]="!showSearch">
      <span class="select-text">
        Total tracks: {{ (tracks.map(filter) | async)?.length }}
        </span>
    </div>
    <button mat-button mat-icon-button
            (click)="showSearch = !showSearch; showSearch ? searchInput.focus() : {}"
            class="searchButton">
      <mat-icon>search</mat-icon>
    </button>
    <button mat-button mat-icon-button
            class="more"
            [matMenuTriggerFor]="Track">
      <mat-icon>more_vert</mat-icon>
    </button>
    <mat-menu #Track>
      <button mat-menu-item (click)="library.addTracksToPlaylist(tracks.map(filter))" [disabled]="(tracks.map(filter) | async)?.length == 0">
        <mat-icon>playlist_add</mat-icon>
        <span>Add all to current playlist</span>
      </button>
      <button mat-menu-item (click)="library.sortTracks(true)" [disabled]="library.sortTracksAlphabetically">
        <mat-icon>sort_by_alpha</mat-icon>
        <span>Sort alphabetically</span>
      </button>
      <button mat-menu-item (click)="library.sortTracks(false)" [disabled]="!library.sortTracksAlphabetically">
        <mat-icon>sort</mat-icon>
        <span>Sort by file name</span>
      </button>
    </mat-menu>
  </div>
  <div #list class="list-wrapper" (swiperight)="previous.emit()" (swipeleft)="next.emit()">
    <mat-list class="tracks" [class.sorted-alpha]="library.sortTracksAlphabetically" dense>
      <ng-container *ngFor="let track of tracks.map(filter) | async; trackBy: trackByURL">
        <a mat-list-item
           class="track hover"
           (click)="library.playTracks(tracks.map(filter), track); next.emit()">
          <div matLine class="primary-text">
            <mat-icon *ngIf="track.warn && settings.warnOnMissingTags" color="warn" matTooltip="Unset tags!">warning</mat-icon>
            <mat-icon color="warn" class="favorite-icon" *ngIf="favorites.isFavorite(track)">favorite</mat-icon>
            <span class="track-name" [innerHtml]="track.metadata.title | sgSearch:search"></span>
          </div>
          <div matLine class="secondary-text">
            {{ track.metadata.duration | sgTime }}
            <span *ngIf="isMultipleAlbumsSelected()">â€¢ {{ track.metadata.album }}</span>
          </div>
          <button mat-button mat-icon-button
                  class="more"
                  *ngIf="currentTrack != track"
                  [matMenuTriggerFor]="trackMenu"
                  (click)="$event.stopPropagation()">
            <mat-icon>more_vert</mat-icon>
          </button>
          <mat-menu #trackMenu>
            <button mat-menu-item (click)="library.playTrack(track)">
              <mat-icon>play_arrow</mat-icon>
              <span>Play</span>
            </button>
            <button mat-menu-item (click)="library.playTrackNext(track)">
              <mat-icon>play_arrow</mat-icon>
              <span>Play next</span>
            </button>
            <button mat-menu-item (click)="library.addTrackToPlaylist(track)">
              <mat-icon>playlist_add</mat-icon>
              <span>Add to current playlist</span>
            </button>
            <button mat-menu-item [matMenuTriggerFor]="playlistsMenu" disabled>
              <mat-icon>playlist_add</mat-icon>
              <span>Add to playlist</span>
            </button>
            <button mat-menu-item (click)="favorites.addToFavorites(track)" *ngIf="!favorites.isFavorite(track)">
              <mat-icon>favorite_border</mat-icon>
              <span>Add to favorites</span>
            </button>
            <button mat-menu-item (click)="favorites.removeFromFavorites(track)" *ngIf="favorites.isFavorite(track)">
              <mat-icon>favorite</mat-icon>
              <span>Remove from favorites</span>
            </button>
            <button mat-menu-item (click)="openDetailsDialog(track)">
              <mat-icon>details</mat-icon>
              <span>Details</span>
            </button>
          </mat-menu>
          <mat-menu #playlistsMenu="matMenu">
            <button mat-menu-item>
              <mat-icon>add</mat-icon>
              New playlist
            </button>
            <mat-divider></mat-divider>
            <button mat-menu-item>
              <mat-icon>album</mat-icon>
              Playlist1
            </button>
            <button mat-menu-item>
              <mat-icon>album</mat-icon>
              Playlist2
            </button>
          </mat-menu>
          <button mat-button mat-icon-button
                  class = "playPause"
                  *ngIf="currentTrack == track"
                  (click)="playing ? audio.pause() : audio.play(); $event.stopPropagation()">
            <mat-icon>{{ playing ? 'pause' : 'play_arrow' }}</mat-icon>
          </button>
          <span class="spinner" *ngIf="currentTrack == track">
            <mat-progress-spinner [diameter]="40"
                                  [mode]="loading ? 'indeterminate' : 'determinate'"
                                  [value]="currentTime / duration * 100"></mat-progress-spinner>
          </span>
          <mat-divider></mat-divider>
        </a>
      </ng-container>
    </mat-list>
  </div>
  <app-dictionary *ngIf="library.sortTracksAlphabetically" (letterClicked)="scrollTo($event)"></app-dictionary>
</div>
