<div class="wrapper">
  <div class="controls divider fake-scroll-y">
    <button mat-button mat-icon-button class="back" (click)="onPrevious.emit()">
      <mat-icon>arrow_back</mat-icon>
    </button>
    <mat-form-field floatLabel="never" class="search" [class.show]="showSearch">
      <input matInput #searchInput title="Search" [(ngModel)]="search" spellcheck="false">
      <mat-placeholder>
        <mat-icon>search</mat-icon>
        Search a track
      </mat-placeholder>
      <button mat-button *ngIf="search" matSuffix mat-icon-button aria-label="Clear" (click)="search=''">
        <mat-icon>close</mat-icon>
      </button>
    </mat-form-field>
    <div class="controls-meta" [class.show]="!showSearch">
      <span class="select-text">
        Total tracks: {{ (library.tracksObs.map(filterAndSort) | async)?.length }}
        <!--TODO: If tracks.length > 300 show warning-->
      </span>
    </div>
    <button mat-button mat-icon-button
            (click)="showSearch = !showSearch; showSearch ? searchInput.focus() : {}"
            class="searchButton">
      <mat-icon>search</mat-icon>
    </button>
    <button mat-button mat-icon-button
            class="more"
            [matMenuTriggerFor]="Track">
      <mat-icon>more_vert</mat-icon>
    </button>
    <mat-menu #Track>
      <button mat-menu-item (click)="library.addTracksToPlaylist(library.tracksObs.map(filterAndSort))" [disabled]="(library.tracksObs.map(filterAndSort) | async)?.length == 0">
        <mat-icon>playlist_add</mat-icon>
        <span>Add all to current playlist</span>
      </button>
      <button mat-menu-item (click)="sortedAlphabetically = true" [disabled]="sortedAlphabetically">
        <mat-icon>sort_by_alpha</mat-icon>
        <span>Sort alphabetically</span>
      </button>
      <button mat-menu-item (click)="sortedAlphabetically = false" [disabled]="!sortedAlphabetically">
        <mat-icon>sort</mat-icon>
        <span>Sort by file name</span>
      </button>
    </mat-menu>
  </div>
  <div #list class="list-wrapper" (swiperight)="onPrevious.emit()" (swipeleft)="onNext.emit()">
    <mat-list class="tracks" [class.sorted-alpha]="sortedAlphabetically" dense>
      <ng-container *ngFor="let track of library.tracksObs.map(filterAndSort) | async; trackBy: trackByURL">
        <a mat-list-item
           class="track hover"
           (click)="library.playTracks(library.tracksObs.map(filterAndSort), track); onNext.emit()">
          <div matLine class="primary-text">
            <mat-icon *ngIf="track.warn && settings.warnOnMissingTags" color="warn" matTooltip="Unset tags!">warning</mat-icon>
            <mat-icon color="warn" class="favorite-icon" *ngIf="favorites.isFavorite(track)">favorite</mat-icon>
            <span class="track-name" [innerHtml]="track.metadata.title | sgSearch:search"></span>
          </div>
          <div matLine class="secondary-text">
            {{ track.metadata.duration | sgTime }}
            <span *ngIf="isMultipleAlbumsSelected()">â€¢ {{ track.metadata.album }}</span>
          </div>
          <button mat-button mat-icon-button
                  class="more"
                  *ngIf="library.currentTrack != track"
                  [matMenuTriggerFor]="trackMenu"
                  (click)="$event.stopPropagation()">
            <mat-icon>more_vert</mat-icon>
          </button>
          <mat-menu #trackMenu>
            <button mat-menu-item (click)="library.playTrack(track)">
              <mat-icon>play_arrow</mat-icon>
              <span>Play</span>
            </button>
            <button mat-menu-item (click)="library.playTrackNext(track)">
              <mat-icon>play_arrow</mat-icon>
              <span>Play next</span>
            </button>
            <button mat-menu-item (click)="addTrackToPlaylist(track)">
              <mat-icon>playlist_add</mat-icon>
              <span>Add to current playlist</span>
            </button>
            <button mat-menu-item [matMenuTriggerFor]="playlistsMenu" disabled>
              <mat-icon>playlist_add</mat-icon>
              <span>Add to playlist</span>
            </button>
            <button mat-menu-item (click)="favorites.addToFavorites(track)" *ngIf="!favorites.isFavorite(track)">
              <mat-icon>favorite_border</mat-icon>
              <span>Add to favorites</span>
            </button>
            <button mat-menu-item (click)="favorites.removeFromFavorites(track)" *ngIf="favorites.isFavorite(track)">
              <mat-icon>favorite</mat-icon>
              <span>Remove from favorites</span>
            </button>
            <button mat-menu-item (click)="openDetailsDialog(track)">
              <mat-icon>details</mat-icon>
              <span>Details</span>
            </button>
          </mat-menu>
          <mat-menu #playlistsMenu="matMenu">
            <button mat-menu-item>
              <mat-icon>add</mat-icon>
              New playlist
            </button>
            <mat-divider></mat-divider>
            <button mat-menu-item>
              <mat-icon>album</mat-icon>
              Playlist1
            </button>
            <button mat-menu-item>
              <mat-icon>album</mat-icon>
              Playlist2
            </button>
          </mat-menu>
          <button mat-button mat-icon-button
                  class = "playPause"
                  *ngIf="library.currentTrack == track"
                  (click)="library.audio.playing ? library.audio.pause() : library.audio.play(); $event.stopPropagation()">
            <mat-icon>{{ library.audio.playing ? 'pause' : 'play_arrow' }}</mat-icon>
          </button>
          <span class="spinner" *ngIf="library.currentTrack == track">
            <mat-progress-spinner diameter="40"
                                  [mode]="library.audio.loading ? 'indeterminate' : 'determinate'"
                                  [value]="library.audio.currentTime / library.audio.duration * 100"></mat-progress-spinner>
          </span>
          <mat-divider></mat-divider>
        </a>
      </ng-container>
    </mat-list>
  </div>
  <div *ngIf="sortedAlphabetically" class="alphabet" (click)="$event.stopPropagation()">
    <ol>
      <li *ngFor="let letter of alphabet" (click)="scrollTo(letter)">{{ letter }}</li>
    </ol>
  </div>
</div>
